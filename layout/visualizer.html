<script>
    'use strict';
    function checkVersion(versions, version) {
        version = version.toLowerCase();
        if (version && version[0] >= '0' && version[0] <= '9' && !version.startsWith('v')) version = 'v' + version;
        var idx = versions.indexOf(version);
        if (idx > -1) {
            version = versions[idx];
        }
        else {
            // Fallback version is HEAD-min
            version = 'HEAD-min';
        }
        return version;
    }
    window.onload = function () {
        var prom;
        var selfContained = '{{ config.selfContained}}';
        if (selfContained) {
            prom = Promise.resolve([]);
        } else {
            prom = Promise.resolve($.getJSON('{{ config.cdn }}/visualizer/versions.php'));
        }
        prom.then(function (versions) {
            var url;
            var uri = new URI(window.location.href);
            var search = uri.search(true);
            url = '{{ viewURL }}';
            var fallbackVersion = '{{ version }}';
            var version;
            if (search.viewURL) {
                url = search.viewURL;
            }
            if (search.v) {
                version = checkVersion(versions, search.v);
            }
            if (!version) {
                version = checkVersion(versions, fallbackVersion);
            }
            if (!search.loadversion)
                addVisualizer(version, search);
            else {
                $.ajax({
                    url: url,
                    dataType: 'json',
                    type: 'GET',
                    success: function (data) {
                        addVisualizer(checkVersion(versions, data.version), search);
                    },
                    error: function (err) {
                        console.log('error', err);
                    }
                })
            }
        });

        function addVisualizer(version, search) {
            var cdn = '{{config.cdn}}';
            var direct = '{{config.direct}}';
            var selfContained = '{{config.selfContained}}';
            var visualizer = document.createElement('script');
            var baseUrl;
            if(!selfContained) {
                baseUrl = (search.direct ? direct : cdn) + '/visualizer/' + version;
            } else {
                baseUrl = '{{ version | cdnVisualizer(reldir) }}';
            }

            visualizer.setAttribute('data-main', baseUrl+ '/init');
            visualizer.setAttribute('src', baseUrl + '/components/requirejs/require.js');
            document.head.appendChild(visualizer);
        }
    }
</script>
<div id="errorMessage"></div>
<tr>
    <td class="left"></td>
    <td colspan="3">
        <div id="ci-visualizer" {% if dataURL %} dataURL="{{ dataURL }}" {% endif %} viewURL="{{ viewURL }}"
             config="{{ readConfig }}"/>
    </td>
    <td class="right"></td>
</tr>
