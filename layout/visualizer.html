<script>
    'use strict';
    function checkVersion(versions, version) {
	if (version.indexOf("v")!=0) version="v"+version;
        var idx = versions.indexOf(version);
        if (idx > -1) {
            version = versions[idx];
        }
        else {
            return null;
        }
        return version;
    }
    window.onload = function () {
        $.getJSON('http://www.lactame.com/visualizer/versions.php').then(function(versions) {
            var url;
            var div = document.getElementById('errorMessage');
            var uri = new URI(window.location.href);
            var search = uri.search(true);
            url = '{{ viewURL }}';
            var fallbackVersion = '{{ version }}';
            var version;
            if(search.viewURL) {
                url = search.viewURL;
            }
            if(!url) {
                div.innerHTML = 'No view URL specified';
                return;
            }
            if(search.v) {
                version = checkVersion(versions, search.v);
            }
            if(!version) {
                version = checkVersion(versions, fallbackVersion);
            }
            if(!version) {
                version = 'HEAD';
            }
            addVisualizer(version, search);
        });

        function addVisualizer(version, search) {
            var visualizer = document.createElement('script');
            var prefix = 'http://' + (search.direct ? 'direct' : 'www') + '.lactame.com/visualizer/';
            visualizer.setAttribute('data-main', prefix + version + '/init');
            visualizer.setAttribute('src', prefix + version + '/components/requirejs/require.js');
            document.head.appendChild(visualizer);
        }
    }
</script>
<div id="errorMessage"></div>
<tr>
    <td class="left"></td>
    <td colspan="3">
        <div id="ci-visualizer" style="margin-top: 15px" {% if dataURL %} dataURL="{{ dataURL }}" {% endif %} viewURL="{{ viewURL }}" config="{{ config.configUrl }}"/>
    </td>
    <td class="right"></td>
</tr>
